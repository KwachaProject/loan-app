{% extends "base.html" %}

{% block title %}View Loans{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4 text-primary">
    <i class="bi bi-clipboard-data me-2"></i>Loan Applications
  </h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="card border-primary shadow">
    <div class="card-header bg-primary text-white">
      <i class="bi bi-table me-2"></i>Loan Portfolio Overview
    </div>

    <div class="card-body p-0">
      <table class="table table-hover align-middle mb-0" id="loanTable">
        <thead class="bg-light-primary">
          <tr>
            <th class="text-primary"><i class="bi bi-person me-1"></i>Customer</th>
            <th class="text-primary">Amount (MWK)</th>
            <th class="text-primary">Term</th>
            <th class="text-primary">Monthly Pay (MWK)</th>
            <th class="text-primary">Status</th>
            <th class="text-primary">Requested</th>
            <th class="text-primary">Category</th>
            <th class="text-primary">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in loans %}
          <tr>
            <td class="fw-medium">{{ entry.customer.first_name }} {{ entry.customer.last_name }}</td>
            <td>{{ "%.2f"|format(entry.loan.loan_amount or 0) }}</td>
            <td>{{ entry.loan.term_months }}</td>
            <td class="text-nowrap">{{ "%.2f"|format(entry.loan.monthly_instalment or 0) }}</td>
            <td>
              {% if entry.loan.application_status == 'approved' %}
                <span class="badge
                  {% if entry.loan.loan_state == 'active' %}bg-primary
                  {% elif entry.loan.loan_state == 'closed' %}bg-secondary
                  {% elif entry.loan.loan_state == 'written_off' %}bg-danger
                  {% elif entry.loan.loan_state == 'topped_up' %}bg-info
                  {% else %}bg-warning{% endif %}">
                  {{ entry.loan.loan_state|replace('_', ' ')|upper }}
                </span>
              {% elif entry.loan.application_status == 'pending' %}
                <span class="badge bg-warning-soft text-warning">
                  <i class="bi bi-clock-history me-1"></i>{{ entry.loan.application_status|title }}
                </span>
              {% else %}
                <span class="badge bg-danger-soft text-danger">
                  <i class="bi bi-x-circle me-1"></i>{{ entry.loan.application_status|title }}
                </span>
              {% endif %}
            </td>
            <td>{{ entry.loan.created_at.strftime('%d %b %Y') if entry.loan.created_at }}</td>
            <td>
              <span class="badge bg-primary-soft text-primary">{{ entry.loan.category }}</span>
            </td>
            <td class="text-nowrap">
              <div class="d-flex gap-2">
                <button type="button"
                        class="btn btn-sm btn-outline-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#loanDocsModal{{ entry.loan.id }}">
                  <i class="bi bi-file-earmark-text me-1"></i>Docs
                </button>
                <form method="POST" action="{{ url_for('process_loan', loan_id=entry.loan.id, action='approve') }}">
                  <button class="btn btn-success-soft btn-sm px-3 py-1" type="submit"
                          {% if entry.loan.application_status == 'approved' %}disabled{% endif %}>
                    <i class="bi bi-check2"></i>
                  </button>
                </form>
                <form method="POST" action="{{ url_for('process_loan', loan_id=entry.loan.id, action='reject') }}">
                  <button class="btn btn-danger-soft btn-sm px-3 py-1" type="submit"
                          {% if entry.loan.application_status == 'rejected' %}disabled{% endif %}>
                    <i class="bi bi-x"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% set label_map = {
  'loan_form': 'Loan Form',
  'live_photo': 'Live Photo',
  'payslip': 'Payslip',
  'id_front': 'National ID (Front)',
  'id_back': 'National ID (Back)',
  'other': 'Other Document'
} %}

{% for entry in loans %}
  <div class="modal fade" id="loanDocsModal{{ entry.loan.id }}" tabindex="-1"
       aria-labelledby="loanDocsModalLabel{{ entry.loan.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loanDocsModalLabel{{ entry.loan.id }}">
            {{ entry.customer.first_name }} {{ entry.customer.last_name }} — Loan #{{ entry.loan.loan_number or entry.loan.id }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          {% set all_docs = entry.unique_docs %}
          {% if all_docs %}
            <div class="document-list">
              {% for doc in all_docs %}
              <div class="document-item mb-2 p-2 border rounded">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ label_map.get(doc.filetype, doc.filetype|replace('_', ' ')|title) }}</strong>
                    <div class="text-muted small">{{ doc.filename }}</div>
                    <div class="status-badge mt-1">
                      {% if doc.file_exists %}
                        <span class="badge bg-success">File exists</span>
                      {% else %}
                        <span class="badge bg-danger">File missing</span>
                      {% endif %}
                    </div>
                  </div>
                  <a href="{{ url_for('view_document', doc_id=doc.id) }}" 
                     class="btn btn-sm btn-outline-primary {% if not doc.file_exists %}disabled{% endif %}"
                     {% if not doc.file_exists %}title="File not found"{% endif %}>
                    <i class="bi bi-eye me-1"></i>View
                  </a>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-warning">No documents found for this customer or loan.</div>
          {% endif %}
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
{% endfor %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize DataTables
    $('#loanTable').DataTable({
      order: [[5, 'desc']],
      columnDefs: [{ orderable: false, targets: [7] }]
    });
    
    // Debug modal events
    document.querySelectorAll('[data-bs-toggle="modal"]').forEach(button => {
      button.addEventListener('click', function() {
        const target = this.getAttribute('data-bs-target');
        console.log('Opening modal:', target);
        
        const modal = new bootstrap.Modal(document.querySelector(target));
        modal.show();
      });
    });
    
    // Add error handling for document links
    document.querySelectorAll('.document-item a').forEach(link => {
      link.addEventListener('click', function(e) {
        if(this.classList.contains('disabled')) {
          e.preventDefault();
          alert('Document file is missing. Please check server logs for details.');
        }
      });
    });
  });
</script>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
  /* Fix modal backdrop */
  .modal-backdrop {
    z-index: 1040 !important;
  }
  
  .modal {
    z-index: 1050 !important;
    display: block !important;
    opacity: 0;
    transition: opacity 0.3s;
  }
  
  .modal.show {
    opacity: 1;
  }
  
  .document-item {
    transition: all 0.2s;
  }
  
  .document-item:hover {
    background-color: #f8f9fa;
    transform: translateY(-2px);
  }
  
  .status-badge .badge {
    font-size: 0.75rem;
    padding: 0.25em 0.4em;
  }
</style>
{% endblock %}