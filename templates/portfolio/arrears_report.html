{% extends "base.html" %}

{% block title %}Arrears Report{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Arrears Report</h2>

    <form method="get" class="form-inline mb-4">
        <div class="row g-2">
            <div class="col-md-3">
                <label class="form-label">Status:</label>
                <select name="status" class="form-select">
                    <option value="unresolved" {% if status == 'unresolved' %}selected{% endif %}>Unresolved</option>
                    <option value="resolved" {% if status == 'resolved' %}selected{% endif %}>Resolved</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Aging:</label>
                <select name="aging" class="form-select">
                    <option value="">Any</option>
                    <option value="30-" {% if aging == '30-' %}selected{% endif %}>30+ days</option>
                    <option value="60-" {% if aging == '60-' %}selected{% endif %}>60+ days</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Tenure:</label>
                <select name="tenure" class="form-select">
                    <option value="">All</option>
                    {% for t in tenures %}
                        <option value="{{ t }}" {% if tenure == t %}selected{% endif %}>{{ t }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Category:</label>
                <select name="category" class="form-select">
                    <option value="">All</option>
                    {% for c in categories %}
                        <option value="{{ c }}" {% if category == c %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="mt-3">
            <button type="submit" class="btn btn-primary">Apply Filters</button>
        </div>
    </form>

    <ul class="nav nav-tabs mb-3" id="arrearsTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="aging-tab" data-bs-toggle="tab" data-bs-target="#aging" type="button" role="tab">Portfolio Aging Schedule</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">Summary by Aging</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rules-tab" data-bs-toggle="tab" data-bs-target="#rules" type="button" role="tab">Provision Rules</button>
        </li>
    </ul>

    <div class="tab-content" id="arrearsTabContent">
        <!-- Aging Tab -->
        <div class="tab-pane fade show active" id="aging" role="tabpanel">
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Aging Bracket</th>
                        <th>Outstanding Loans</th>
                        <th>Value of Loans (MK)</th>
                        <th>Provision Amount (MK)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in aging_schedule %}
                    <tr>
                        <td>{{ row.bracket }}</td>
                        <td>{{ row.num_loans }}</td>
                        <td>{{ row.value | round(2) }}</td>
                        <td>{{ row.provision | round(2) }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="fw-bold">
                        <td>TOTAL</td>
                        <td>{{ aging_schedule|sum(attribute='num_loans') }}</td>
                        <td>{{ aging_schedule|sum(attribute='value') | round(2) }}</td>
                        <td>{{ aging_schedule|sum(attribute='provision') | round(2) }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Summary Tab -->
        <div class="tab-pane fade" id="summary" role="tabpanel">
            <table class="table table-striped">
                <thead class="table-secondary">
                    <tr>
                        <th>Aging Bracket</th>
                        <th>Total Arrears (MK)</th>
                        <th>% of Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in aging_summary %}
                    <tr>
                        <td>{{ row.bracket }}</td>
                        <td>{{ row.amount | round(2) }}</td>
                        <td>{{ row.percentage | round(1) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Provision Rules Tab -->
        <div class="tab-pane fade" id="rules" role="tabpanel">
            <form method="POST" action="{{ url_for('save_provision_rule') }}" class="mb-4 mt-3">
                <div class="row">
                    <div class="col">
                        <label>Category</label>
                        <select name="category" class="form-control">
                            {% for cat in categories %}
                                <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col">
                        <label>Tenure Group</label>
                        <select name="tenure_group" class="form-control">
                            <option value="1-30">1–30 days</option>
                            <option value="31-60">31–60 days</option>
                            <option value="61-90">61–90 days</option>
                            <option value="91-180">91–180 days</option>
                            <option value="180+">Over 180 days</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>PD (0–1)</label>
                        <input type="number" step="0.01" name="pd" class="form-control" required>
                    </div>
                    <div class="col">
                        <label>LGD (0–1)</label>
                        <input type="number" step="0.01" name="lgd" class="form-control" required>
                    </div>
                    <div class="col">
                        <label>&nbsp;</label>
                        <button class="btn btn-success form-control">Save Rule</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
