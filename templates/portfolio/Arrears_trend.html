{% extends "base.html" %}
{% block title %}Arrears Trend Comparison{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Arrears Trend Comparison</h2>

  <form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
      <label for="period1" class="form-label">First Period</label>
      <select id="period1" name="period1" class="form-select">
        <option value="this_quarter" {% if period1 == 'this_quarter' %}selected{% endif %}>This Quarter</option>
        <option value="last_quarter" {% if period1 == 'last_quarter' %}selected{% endif %}>Last Quarter</option>
        <option value="same_quarter_last_year" {% if period1 == 'same_quarter_last_year' %}selected{% endif %}>Same Quarter Last Year</option>
        <option value="12w" {% if period1 == '12w' %}selected{% endif %}>Last 12 Weeks</option>
      </select>
    </div>

    <div class="col-md-3">
      <label for="period2" class="form-label">Second Period</label>
      <select id="period2" name="period2" class="form-select">
        <option value="this_quarter" {% if period2 == 'this_quarter' %}selected{% endif %}>This Quarter</option>
        <option value="last_quarter" {% if period2 == 'last_quarter' %}selected{% endif %}>Last Quarter</option>
        <option value="same_quarter_last_year" {% if period2 == 'same_quarter_last_year' %}selected{% endif %}>Same Quarter Last Year</option>
        <option value="12w" {% if period2 == '12w' %}selected{% endif %}>Last 12 Weeks</option>
      </select>
    </div>

    <div class="col-md-3">
      <label for="category" class="form-label">Category</label>
      <select id="category" name="category" class="form-select">
        <option value="" {% if not category %}selected{% endif %}>All</option>
        <option value="personal" {% if category == 'personal' %}selected{% endif %}>Personal</option>
        <option value="business" {% if category == 'business' %}selected{% endif %}>Business</option>
        <option value="education" {% if category == 'education' %}selected{% endif %}>Education</option>
      </select>
    </div>

    <div class="col-md-2">
      <label for="tenure" class="form-label">Tenure</label>
      <select id="tenure" name="tenure" class="form-select">
        <option value="" {% if not tenure %}selected{% endif %}>All</option>
        <option value="6" {% if tenure == '6' %}selected{% endif %}>6 months</option>
        <option value="12" {% if tenure == '12' %}selected{% endif %}>12 months</option>
        <option value="24" {% if tenure == '24' %}selected{% endif %}>24 months</option>
        <option value="36" {% if tenure == '36' %}selected{% endif %}>36 months</option>
      </select>
    </div>

    <div class="col-md-1 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">Compare</button>
    </div>
  </form>

  <div class="mb-3">
    <a href="{{ url_for('download_arrears_csv', period1=period1, period2=period2, category=category, tenure=tenure) }}" class="btn btn-success">
      Download CSV
    </a>
  </div>

  <canvas id="arrearsChart" height="140"></canvas>

  <div id="chart-data" 
         data-wks='["WK1", "WK2", "WK3", "WK4", "WK5", "WK6", "WK7", "WK8", "WK9", "WK10", "WK11", "WK12"]'
         data-count1='{{ count1 | tojson | safe }}'
         data-amount1='{{ amount1 | tojson | safe }}'
         data-count2='{{ count2 | tojson | safe }}'
         data-amount2='{{ amount2 | tojson | safe }}'>
    </div>

  <div class="row mt-5">
    <div class="col-md-6">
      <h5>Period 1</h5>
      <table class="table table-bordered table-sm">
        <thead class="table-dark">
          <tr><th>Date</th><th>Count</th><th>Amount</th></tr>
        </thead>
        <tbody>
          {% for d, c, a in zipped1 %}
            <tr>
              <td>{{ d }}</td>
              <td>{{ c }}</td>
              <td>{{ "%.2f"|format(a) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="col-md-6">
      <h5>Period 2</h5>
      <table class="table table-bordered table-sm">
        <thead class="table-dark">
          <tr><th>Date</th><th>Count</th><th>Amount</th></tr>
        </thead>
        <tbody>
          {% for d, c, a in zipped2 %}
            <tr>
              <td>{{ d }}</td>
              <td>{{ c }}</td>
              <td>{{ "%.2f"|format(a) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
      const arrearsData = document.getElementById('chart-data');
      const wks = JSON.parse(arrearsData.dataset.wks || '[]');
      const count1 = JSON.parse(arrearsData.dataset.count1 || '[]');
      const amount1 = JSON.parse(arrearsData.dataset.amount1 || '[]');
      const count2 = JSON.parse(arrearsData.dataset.count2 || '[]');
      const amount2 = JSON.parse(arrearsData.dataset.amount2 || '[]');

      new Chart(document.getElementById('arrearsChart'), {
        type: 'line',
        data: {
          labels: wks,
          datasets: [
            {
              label: 'Amount (Period 1)',
              data: amount1,
              yAxisID: 'y',
              borderColor: '#0d6efd',
              backgroundColor: 'rgba(13, 110, 253, 0.2)',
              tension: 0.3,
              pointRadius: 3,
              borderWidth: 2
            },
            {
              label: 'Count (Period 1)',
              data: count1,
              yAxisID: 'y1',
              borderColor: '#ffc107',
              backgroundColor: 'rgba(255, 193, 7, 0.2)',
              tension: 0.3,
              pointRadius: 3,
              borderWidth: 2
            },
            {
              label: 'Amount (Period 2)',
              data: amount2,
              yAxisID: 'y',
              borderColor: '#198754',
              backgroundColor: 'rgba(25, 135, 84, 0.2)',
              borderDash: [5, 5],
              tension: 0.3,
              pointRadius: 3,
              borderWidth: 2
            },
            {
              label: 'Count (Period 2)',
              data: count2,
              yAxisID: 'y1',
              borderColor: '#dc3545',
              backgroundColor: 'rgba(220, 53, 69, 0.2)',
              borderDash: [5, 5],
              tension: 0.3,
              pointRadius: 3,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false
          },
          stacked: false,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            y: {
              type: 'linear',
              position: 'left',
              title: {
                display: true,
                text: 'Amount (â‚¦)'
              }
            },
            y1: {
              type: 'linear',
              position: 'right',
              suggestedMax: 100,
              grid: {
                drawOnChartArea: false
              },
              title: {
                display: true,
                text: 'Count (Loans)'
              }
            }
          }
        }
      });
    </script>
{% endblock %}
