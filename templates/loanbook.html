{% extends "base.html" %}
{% block title %}Loan Book{% endblock %}

{% block content %}

<style>
  .table-responsive {
    max-height: calc(100vh - 300px);
    overflow: auto;
    position: relative;
  }
  .table-responsive thead th {
    position: sticky;
    top: 0;
    background: white;
    z-index: 2;
    box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);
  }
  .table-responsive tfoot td {
    position: sticky;
    bottom: 0;
    background: white;
    z-index: 2;
    box-shadow: 0 -2px 2px -1px rgba(0,0,0,0.1);
  }
  #loadMoreBtn {
    transition: background-color 0.2s ease;
    border-radius: 25px;
    padding: 0.5rem 1.5rem;
    font-weight: 600;
  }
  #loadMoreBtn:hover {
    background-color: #0056b3;
    transform: scale(1.03);
  }
  /* Align numeric columns */
  table.table tbody td:nth-child(4),
  table.table tbody td:nth-child(5),
  table.table tbody td:nth-child(7),
  table.table tbody td:nth-child(8),
  table.table tbody td:nth-child(9),
  table.table tbody td:nth-child(10),
  table.table tbody td:nth-child(11),
  table.table tbody td:nth-child(12),
  table.table tbody td:nth-child(13),
  table.table tbody td:nth-child(14),
  table.table tfoot td:nth-child(4),
  table.table tfoot td:nth-child(5),
  table.table tfoot td:nth-child(7),
  table.table tfoot td:nth-child(8),
  table.table tfoot td:nth-child(9),
  table.table tfoot td:nth-child(10),
  table.table tfoot td:nth-child(11),
  table.table tfoot td:nth-child(12),
  table.table tfoot td:nth-child(13),
  table.table tfoot td:nth-child(14) {
    text-align: right;
  }
</style>

<h2 class="mb-4">Loan Book</h2>

<!-- REPORT GENERATOR PANEL -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-light">
    <strong>Generate Loan Report</strong>
  </div>
  <div class="card-body">
    <form method="get" action="{{ url_for('generate_report') }}" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label for="start_date" class="form-label">Start Date</label>
        <input type="date" class="form-control" name="start_date" id="start_date"
               value="{{ request.args.get('start_date', '') }}">
      </div>
      <div class="col-md-3">
        <label for="end_date" class="form-label">End Date</label>
        <input type="date" class="form-control" name="end_date" id="end_date"
               value="{{ request.args.get('end_date', '') }}">
      </div>
      <div class="col-md-3">
        <label for="status" class="form-label">Status</label>
        <select class="form-select" name="status" id="status">
          <option value="">All</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
      </div>
      <div class="col-md-3 text-end">
        <button type="submit" class="btn btn-success">
          <i class="bi bi-download"></i> Export to Excel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- SEARCH / FILTER BAR -->
<div class="row search-bar">
  <div class="col-md-6 mb-2">
    <input type="text" id="searchInput" class="form-control" placeholder="Search by name or status">
  </div>
  <div class="col-md-3 mb-2">
    <select id="categoryFilter" class="form-select">
      <option value="">All Categories</option>
      {% for category in loan_categories %}
      <option value="{{ category }}" {% if request.args.get('category') == category|string %}selected{% endif %}>Category {{ category }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3 mb-2">
    <select id="tenureFilter" class="form-select">
      <option value="">All Tenures</option>
      {% for tenure in loan_tenures %}
      <option value="{{ tenure }}" {% if request.args.get('tenure')|int == tenure %}selected{% endif %}>{{ tenure }} months</option>
      {% endfor %}
    </select>
  </div>
</div>

<!-- EXPORT BUTTON -->
<button class="btn btn-success mb-3" onclick="exportToExcel()">Export Table to Excel</button>

<!-- LOAN TABLE -->
<div class="table-responsive" style="max-height: 600px; overflow: auto;">
  <table class="table table-bordered table-hover text-nowrap" id="loanTable">
    <thead class="table-light sticky-top">
      <tr>
        <th>Loan Number</th>
        <th>File Number</th>
        <th>Customer</th>
        <th>Loan Amount</th>
        <th>Term Months</th>
        <th>Category</th>
        <th>CRB Fee</th>
        <th>Origination</th>
        <th>Insurance</th>
        <th>Total Fees</th>
        <th>Collection Fees</th>
        <th>Instalment</th>
        <th>Total Repayment</th>
        <th>Principal Balance</th>
      </tr>
    </thead>
    <tbody id="loanTableBody">
      {% include "partials/_loan_rows.html" %}
    </tbody>
    <tfoot class="table-light fw-bold">
      <tr>
        <td colspan="3">Totals</td>
        <td>{{ "{:,.2f}".format(totals.loan_amount or 0) }}</td>
        <td></td>
        <td></td>
        <td>{{ "{:,.2f}".format(totals.crb_fees or 0) }}</td>
        <td>{{ "{:,.2f}".format(totals.origination_fees or 0) }}</td>
        <td>{{ "{:,.2f}".format(totals.insurance_fees or 0) }}</td>
        <td>{{ "{:,.2f}".format(totals.total_fees or 0) }}</td>
        <td>{{ "{:,.2f}".format(totals.collection_fees or 0) }}</td>
        <td>{{ "{:,.2f}".format(totals.monthly_instalment or 0) }}</td>
        <td>{{ "{:,.2f}".format(totals.total_repayment or 0) }}</td>
        <td>{{ "{:,.2f}".format(totals.total_balance or 0) }}</td>
      </tr>
    </tfoot>
  </table>
</div>

<div class="text-center my-3">
  {% if has_next %}
    <button id="loadMoreBtn" class="btn btn-primary" data-page="{{ page + 1 }}">Load More</button>
  {% endif %}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  const searchInput = document.getElementById("searchInput");
  const categoryFilter = document.getElementById("categoryFilter");
  const tenureFilter = document.getElementById("tenureFilter");
  const table = document.getElementById("loanTable");
  const tableBody = document.getElementById("loanTableBody");

  function filterTable() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedCategory = categoryFilter.value.toLowerCase();
    const selectedTenure = tenureFilter.value;

    const rows = tableBody.querySelectorAll("tr");
    rows.forEach(row => {
      const name = row.cells[2].textContent.toLowerCase();
      const category = row.cells[5].textContent.toLowerCase();
      const tenure = row.cells[4].textContent;

      const matchSearch = name.includes(searchTerm);
      const matchCategory = !selectedCategory || category === selectedCategory;
      const matchTenure = !selectedTenure || tenure === selectedTenure;

      row.style.display = (matchSearch && matchCategory && matchTenure) ? "" : "none";
    });
  }

  searchInput.addEventListener("input", filterTable);
  categoryFilter.addEventListener("change", filterTable);
  tenureFilter.addEventListener("change", filterTable);

  function exportToExcel() {
    const wb = XLSX.utils.book_new();
    const headers = Array.from(document.querySelectorAll("thead th")).map(th => th.textContent.trim());
    const visibleRows = Array.from(document.querySelectorAll("tbody tr")).filter(r => r.style.display !== "none");
    const data = visibleRows.map(row =>
      Array.from(row.cells).map(cell => cell.textContent.trim())
    );
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    XLSX.utils.book_append_sheet(wb, ws, "Loan Book");
    XLSX.writeFile(wb, "loan_book.xlsx");
  }

  document.addEventListener("DOMContentLoaded", function () {
    const loadMoreBtn = document.getElementById("loadMoreBtn");
    if (loadMoreBtn) {
      loadMoreBtn.addEventListener("click", function () {
        const page = this.dataset.page;
        this.textContent = "Loading...";
        fetch(`/loan-book?page=${page}&ajax=true`)
          .then(response => response.json())
          .then(data => {
            tableBody.insertAdjacentHTML("beforeend", data.html);
            if (data.has_next) {
              loadMoreBtn.dataset.page = parseInt(page) + 1;
              loadMoreBtn.textContent = "Load More";
            } else {
              loadMoreBtn.remove();
            }
          });
      });
    }
  });
</script>

{% endblock %}
