{% extends "base.html" %}

{% block title %}Document Repair Tool{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">
    <i class="bi bi-wrench me-2"></i>Document Repair Tool
  </h2>
  
  <div class="card shadow mb-4">
    <div class="card-header bg-warning">
      <i class="bi bi-exclamation-triangle me-2"></i>Document Path Repair
    </div>
    <div class="card-body">
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        This tool will fix document paths in the database and move files to the correct location.
      </div>
      
      <div class="mb-3">
        <label class="form-label fw-bold">Current Configuration</label>
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-2">
                  <span class="text-muted">Instance Path:</span>
                  <code>{{ instance_path }}</code>
                </div>
                <div class="mb-2">
                  <span class="text-muted">Root Path:</span>
                  <code>{{ root_path }}</code>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-2">
                  <span class="text-muted">Upload Folder:</span>
                  <code>{{ upload_folder }}</code>
                </div>
                <div class="mb-2">
                  <span class="text-muted">Absolute Path:</span>
                  <code>{{ absolute_path }}</code>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <button id="repairBtn" class="btn btn-warning">
        <i class="bi bi-wrench me-1"></i>Repair Document Paths
      </button>
      
      <div id="results" class="mt-4" style="display:none;"></div>
    </div>
  </div>
  
  <div class="card shadow">
    <div class="card-header bg-info text-white">
      <i class="bi bi-search me-2"></i>Document Verification
    </div>
    <div class="card-body">
      <div class="d-flex justify-content-between mb-3">
        <div>
          <button id="verifyBtn" class="btn btn-info">
            <i class="bi bi-search me-1"></i>Verify All Documents
          </button>
        </div>
        <div>
          <a href="{{ url_for('debug_documents_page') }}" class="btn btn-outline-info">
            <i class="bi bi-bug me-1"></i>Advanced Debug
          </a>
        </div>
      </div>
      
      <div id="verificationResults" class="mt-3" style="display:none;"></div>
    </div>
  </div>
</div>

<script>
document.getElementById('repairBtn').addEventListener('click', async () => {
  const btn = document.getElementById('repairBtn');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="bi bi-arrow-repeat spin me-1"></i> Repairing...';
  
  try {
    const response = await fetch('/repair/documents', { method: 'POST' });
    const data = await response.json();
    
    let html = `
      <div class="card mb-4">
        <div class="card-header bg-${data.status === 'success' ? 'success' : 'danger'} text-white">
          <i class="bi bi-wrench me-2"></i>Repair Results
        </div>
        <div class="card-body">
          <div class="alert alert-${data.status === 'success' ? 'success' : 'danger'}">
            <h5>Repair Operation Completed</h5>
            <p>Updated ${data.updated_count} of ${data.total_documents} documents</p>
            <p class="mb-1">Base path: <code>${data.base_path}</code></p>
    `;
    
    if (data.updated_count === 0) {
      html += `<p class="mt-2">All documents are properly configured</p>`;
    } else {
      html += `<p class="mt-2">Documents moved to: <code>${data.new_location}</code></p>`;
    }
    
    if (data.errors && data.errors.length > 0) {
      html += `<div class="mt-3">
                <h6>Errors Encountered:</h6>
                <ul class="list-group">`;
      data.errors.forEach(error => {
        html += `<li class="list-group-item list-group-item-danger">${error}</li>`;
      });
      html += `</ul></div>`;
    }
    
    html += `</div></div></div>`;
    document.getElementById('results').innerHTML = html;
    document.getElementById('results').style.display = 'block';
    
  } catch (error) {
    document.getElementById('results').innerHTML = `
      <div class="alert alert-danger">
        <h5>Repair Failed</h5>
        <p>Error: ${error.message}</p>
      </div>
    `;
    document.getElementById('results').style.display = 'block';
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
});

document.getElementById('verifyBtn').addEventListener('click', async () => {
  const btn = document.getElementById('verifyBtn');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="bi bi-arrow-repeat spin me-1"></i> Verifying...';
  
  try {
    const response = await fetch('/verify/documents');
    const data = await response.json();
    
    let html = `
      <div class="card">
        <div class="card-header bg-info text-white">
          <i class="bi bi-clipboard-check me-2"></i>Document Verification Results
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <h5>Document Verification</h5>
            <p>Total documents: ${data.documents.length}</p>
            <p>Documents with issues: ${data.documents.filter(d => !d.exists).length}</p>
          </div>
          
          <table class="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>Filename</th>
                <th>Status</th>
                <th>Customer</th>
                <th>Path</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    data.documents.forEach(doc => {
      html += `
        <tr>
          <td>${doc.id}</td>
          <td>${doc.filename}</td>
          <td>
            ${doc.exists 
              ? '<span class="badge bg-success">Exists</span>' 
              : '<span class="badge bg-danger">Missing</span>'}
          </td>
          <td>${doc.customer_id}</td>
          <td class="small">
            <div>Stored: <code>${doc.stored_path || 'None'}</code></div>
            <div>Absolute: <code>${doc.absolute_path || 'None'}</code></div>
          </td>
        </tr>
      `;
    });
    
    html += `</tbody></table></div></div>`;
    document.getElementById('verificationResults').innerHTML = html;
    document.getElementById('verificationResults').style.display = 'block';
    
  } catch (error) {
    document.getElementById('verificationResults').innerHTML = `
      <div class="alert alert-danger">
        <h5>Verification Failed</h5>
        <p>Error: ${error.message}</p>
      </div>
    `;
    document.getElementById('verificationResults').style.display = 'block';
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
});
</script>

<style>
.spin {
  animation: spin 1s linear infinite;
}
@keyframes spin {
  100% { transform: rotate(360deg); }
}
.document-path {
  font-size: 0.85rem;
  word-break: break-all;
}
</style>
{% endblock %}